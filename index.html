<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n Integral STEM para Docentes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.05) 10px,
                rgba(255,255,255,0.05) 20px
            );
            animation: move 20s linear infinite;
        }

        @keyframes move {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .admin-login {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .admin-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background: white;
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .content {
            padding: 40px;
        }

        .progress-indicator {
            position: sticky;
            top: 0;
            width: 100%;
            height: 6px;
            background: #e9ecef;
            z-index: 100;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.05);
        }

        .step.completed {
            background: #4CAF50;
            color: white;
        }

        .registration-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .question-container {
            margin-bottom: 25px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .question-container:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .dimension-label {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .question {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .options {
            display: grid;
            gap: 12px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-section {
            margin-bottom: 25px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: white;
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .score-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 1s ease;
        }

        .recommendations {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .recommendations h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-card h4 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            color: #333;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            position: relative;
            height: 400px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .step-indicator {
                flex-direction: column;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .admin-login {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="admin-login">
        <button class="admin-btn" onclick="showAdminLogin()">üîê Administrador</button>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3>Acceso de Administrador</h3>
            <input type="password" id="admin-password" placeholder="Contrase√±a">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn" onclick="validateAdmin()">Ingresar</button>
                <button class="btn btn-secondary" onclick="closeAdminModal()">Cancelar</button>
            </div>
            <p id="admin-error" style="color: red; margin-top: 10px; display: none;">Contrase√±a incorrecta</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üî¨ Evaluaci√≥n Integral STEM</h1>
            <p>Sistema Profesional de Diagn√≥stico Docente</p>
        </div>

        <div class="content">
            <div class="progress-indicator">
                <div class="progress-bar" id="mainProgress"></div>
            </div>

            <div class="step-indicator">
                <div class="step active" id="step1">
                    <strong>üìã Paso 1</strong><br>Registro
                </div>
                <div class="step" id="step2">
                    <strong>üìù Paso 2</strong><br>Conocimientos
                </div>
                <div class="step" id="step3">
                    <strong>üéØ Paso 3</strong><br>Competencias
                </div>
                <div class="step" id="step4">
                    <strong>üìä Paso 4</strong><br>Resultados
                </div>
            </div>

            <!-- SECCI√ìN 1: REGISTRO -->
            <div id="section-registration" class="section active">
                <div class="registration-form">
                    <h2 style="text-align: center; color: #333; margin-bottom: 25px;">üìã Informaci√≥n del Docente</h2>
                    <form id="teacher-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nombres">Nombres Completos *</label>
                                <input type="text" id="nombres" required placeholder="Ej: Juan Carlos">
                            </div>
                            <div class="form-group">
                                <label for="apellidos">Apellidos Completos *</label>
                                <input type="text" id="apellidos" required placeholder="Ej: Garc√≠a P√©rez">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="identificacion">N√∫mero de Identificaci√≥n *</label>
                                <input type="text" id="identificacion" required placeholder="Ej: 1234567890">
                            </div>
                            <div class="form-group">
                                <label for="grado">Grado que Orienta *</label>
                                <select id="grado" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Preescolar">Preescolar</option>
                                    <option value="1¬∞-5¬∞">Primaria (1¬∞-5¬∞)</option>
                                    <option value="6¬∞-9¬∞">Secundaria (6¬∞-9¬∞)</option>
                                    <option value="10¬∞-11¬∞">Media (10¬∞-11¬∞)</option>
                                    <option value="M√∫ltiples">M√∫ltiples Grados</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="asignatura">Asignatura Principal *</label>
                                <select id="asignatura" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Ciencias Naturales">Ciencias Naturales</option>
                                    <option value="Matem√°ticas">Matem√°ticas</option>
                                    <option value="Tecnolog√≠a e Inform√°tica">Tecnolog√≠a e Inform√°tica</option>
                                    <option value="F√≠sica">F√≠sica</option>
                                    <option value="Qu√≠mica">Qu√≠mica</option>
                                    <option value="Biolog√≠a">Biolog√≠a</option>
                                    <option value="Integrada STEM">Integrada STEM</option>
                                    <option value="Otra">Otra</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="institucion">Instituci√≥n Educativa *</label>
                                <input type="text" id="institucion" required placeholder="Nombre completo">
                            </div>
                        </div>
                    </form>
                </div>

                <div style="text-align: center;">
                    <p style="color: #666; margin-bottom: 20px;">‚è±Ô∏è Tiempo estimado total: 12-15 minutos</p>
                    <button class="btn" onclick="startEvaluation()">Comenzar Evaluaci√≥n Integral</button>
                </div>
            </div>

            <!-- SECCI√ìN 2: TEST CONOCIMIENTOS -->
            <div id="section-knowledge" class="section">
                <h2 style="text-align: center; color: #333; margin-bottom: 20px;">üìù Parte 1: Test de Conocimientos STEM</h2>
                <p style="text-align: center; color: #666; margin-bottom: 30px;">15 preguntas ‚Ä¢ 5 minutos aproximadamente</p>
                
                <div id="knowledge-questions"></div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToSection('registration')">‚¨ÖÔ∏è Volver</button>
                    <button class="btn" id="btn-to-competencies" onclick="goToCompetencies()" disabled>Continuar a Parte 2 ‚û°Ô∏è</button>
                </div>
            </div>

            <!-- SECCI√ìN 3: AUTOEVALUACI√ìN COMPETENCIAS -->
            <div id="section-competencies" class="section">
                <h2 style="text-align: center; color: #333; margin-bottom: 20px;">üéØ Parte 2: Autoevaluaci√≥n de Competencias</h2>
                <p style="text-align: center; color: #666; margin-bottom: 30px;">15 preguntas ‚Ä¢ 8 minutos aproximadamente</p>
                
                <div id="competency-questions"></div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToSection('knowledge')">‚¨ÖÔ∏è Volver</button>
                    <button class="btn" id="btn-to-results" onclick="generateResults()" disabled>Ver Mis Resultados üìä</button>
                </div>
            </div>

            <!-- SECCI√ìN 4: RESULTADOS -->
            <div id="section-results" class="section">
                <div id="results-content"></div>
            </div>

            <!-- SECCI√ìN ADMIN -->
            <div id="section-admin" class="section">
                <h2 style="text-align: center; color: #333; margin-bottom: 30px;">üìä Panel de Administraci√≥n</h2>
                
                <div class="filter-bar">
                    <select id="filter-grado" onchange="filterStats()">
                        <option value="">Todos los Grados</option>
                    </select>
                    <select id="filter-asignatura" onchange="filterStats()">
                        <option value="">Todas las Asignaturas</option>
                    </select>
                    <button class="btn" onclick="downloadAllResults()">üì• Descargar Excel</button>
                    <button class="btn" onclick="generatePDFReport()">üìÑ Generar PDF</button>
                    <button class="btn btn-secondary" onclick="sendToGoogleSheets()">üìä Enviar a Google Sheets</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Evaluados</h4>
                        <div class="value" id="total-teachers">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Promedio Conocimientos</h4>
                        <div class="value" id="avg-knowledge">0%</div>
                    </div>
                    <div class="stat-card">
                        <h4>Promedio Competencias</h4>
                        <div class="value" id="avg-competencies">0%</div>
                    </div>
                    <div class="stat-card">
                        <h4>Promedio General</h4>
                        <div class="value" id="avg-general">0%</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <canvas id="knowledgeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="competencyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="gradeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Resultados Detallados</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Docente</th>
                                <th>ID</th>
                                <th>Grado</th>
                                <th>Asignatura</th>
                                <th>Conocimientos</th>
                                <th>Competencias</th>
                                <th>General</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody"></tbody>
                    </table>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="goToSection('registration')">Volver al Inicio</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "STEM2025";
        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbzUrwpqIINSpADqwihgG9u1NDj4zLc5oTuaTlEu8J5IM49P3lZF0AuQP5QOT3DrgudnkQ/exec";
        
        let teacherInfo = {};
        let knowledgeAnswers = {};
        let competencyAnswers = {};
        let allResults = JSON.parse(localStorage.getItem('stemEvaluationResults')) || [];
        let currentChart1, currentChart2, currentChart3, currentChart4;

        // 15 PREGUNTAS DE CONOCIMIENTOS (3 por categor√≠a)
        const knowledgeQuestions = [
            // Ciencia (3)
            {
                id: 1,
                category: "Ciencia",
                question: "¬øCu√°l es la unidad b√°sica de la herencia en los seres vivos?",
                options: ["Cromosoma", "Gen", "ADN", "Prote√≠na"],
                correct: 1
            },
            {
                id: 2,
                category: "Ciencia",
                question: "En el m√©todo cient√≠fico, ¬øcu√°l es la diferencia entre una hip√≥tesis y una teor√≠a?",
                options: ["No hay diferencia", "La hip√≥tesis es m√°s compleja", "La teor√≠a est√° m√°s respaldada por evidencia", "La teor√≠a es m√°s reciente"],
                correct: 2
            },
            {
                id: 3,
                category: "Ciencia",
                question: "¬øC√≥mo se relaciona la segunda ley de la termodin√°mica con los sistemas biol√≥gicos?",
                options: ["No se relaciona", "Los seres vivos violan esta ley", "Los seres vivos mantienen orden usando energ√≠a externa", "Solo aplica a sistemas no vivos"],
                correct: 2
            },
            // Matem√°ticas (3)
            {
                id: 4,
                category: "Matem√°ticas",
                question: "¬øQu√© estrategia pedag√≥gica es m√°s efectiva para ense√±ar conceptos matem√°ticos abstractos?",
                options: ["Memorizaci√≥n de f√≥rmulas", "Repetici√≥n de ejercicios", "Uso de manipulativos y visualizaci√≥n", "Lectura de teoremas"],
                correct: 2
            },
            {
                id: 5,
                category: "Matem√°ticas",
                question: "¬øQu√© concepto matem√°tico es fundamental para entender las funciones exponenciales?",
                options: ["Suma repetida", "Divisi√≥n", "Multiplicaci√≥n repetida", "Geometr√≠a"],
                correct: 2
            },
            {
                id: 6,
                category: "Matem√°ticas",
                question: "¬øCu√°l es la importancia pedag√≥gica de ense√±ar m√∫ltiples representaciones matem√°ticas?",
                options: ["Confunde a los estudiantes", "Es innecesario", "Solo para estudiantes avanzados", "Facilita la comprensi√≥n profunda y conexiones"],
                correct: 3
            },
            // Tecnolog√≠a (3)
            {
                id: 7,
                category: "Tecnolog√≠a",
                question: "¬øCu√°l es el principio fundamental del pensamiento computacional?",
                options: ["Programaci√≥n", "Uso de computadoras", "Algoritmos complejos", "Descomposici√≥n de problemas"],
                correct: 3
            },
            {
                id: 8,
                category: "Tecnolog√≠a",
                question: "¬øCu√°l es la mejor manera de integrar la tecnolog√≠a en el aula STEM?",
                options: ["Usar tecnolog√≠a en todas las clases", "Solo para presentaciones", "Para reemplazar libros", "Como herramienta para resolver problemas reales"],
                correct: 3
            },
            {
                id: 9,
                category: "Tecnolog√≠a",
                question: "¬øQu√© consideraci√≥n √©tica es m√°s importante al ense√±ar inteligencia artificial?",
                options: ["Sesgo algor√≠tmico y equidad", "Eficiencia del c√≥digo", "Velocidad de procesamiento", "Costo computacional"],
                correct: 0
            },
            // Ingenier√≠a (3)
            {
                id: 10,
                category: "Ingenier√≠a",
                question: "¬øCu√°l es la primera etapa del proceso de dise√±o en ingenier√≠a?",
                options: ["Identificar el problema", "Construir el prototipo", "Probar la soluci√≥n", "Elegir materiales"],
                correct: 0
            },
            {
                id: 11,
                category: "Ingenier√≠a",
                question: "¬øQu√© habilidad es m√°s importante para desarrollar el pensamiento ingenieril en estudiantes?",
                options: ["Pensamiento cr√≠tico y resoluci√≥n creativa", "Memorizaci√≥n de f√≥rmulas", "Uso de calculadoras", "Conocimiento de materiales"],
                correct: 0
            },
            {
                id: 12,
                category: "Ingenier√≠a",
                question: "¬øCu√°l es el rol de la sostenibilidad en el dise√±o ingenieril moderno?",
                options: ["Es opcional", "Solo importante en proyectos ambientales", "Consideraci√≥n central en todo el proceso", "Responsabilidad de otros"],
                correct: 2
            },
            // Integraci√≥n STEM (3)
            {
                id: 13,
                category: "Integraci√≥n STEM",
                question: "¬øQu√© habilidad del siglo XXI es m√°s importante en la educaci√≥n STEM?",
                options: ["Memorizaci√≥n", "Competencia individual", "Velocidad", "Colaboraci√≥n y comunicaci√≥n"],
                correct: 3
            },
            {
                id: 14,
                category: "Integraci√≥n STEM",
                question: "¬øC√≥mo debe abordarse la diversidad en equipos de ingenier√≠a estudiantil?",
                options: ["No es importante", "Crear grupos homog√©neos", "Como fortaleza que mejora la innovaci√≥n", "Evitar diferencias"],
                correct: 2
            },
            {
                id: 15,
                category: "Integraci√≥n STEM",
                question: "¬øCu√°l es el elemento m√°s importante en un proyecto STEM interdisciplinario exitoso?",
                options: ["Tecnolog√≠a avanzada", "Duraci√≥n del proyecto", "N√∫mero de estudiantes", "Conexiones aut√©nticas entre disciplinas"],
                correct: 3
            }
        ];

        // 15 PREGUNTAS DE COMPETENCIAS (3 por dimensi√≥n x 5 dimensiones)
        const competencyQuestions = [
            // Dominio Disciplinar (3)
            {
                id: 16,
                dimension: "Dominio Disciplinar",
                question: "¬øCon qu√© frecuencia actualizo mis conocimientos en las disciplinas STEM que ense√±o?",
                options: [
                    { text: "Constantemente (mensual)", value: 4 },
                    { text: "Frecuentemente (trimestral)", value: 3 },
                    { text: "Ocasionalmente (semestral)", value: 2 },
                    { text: "Raramente (anual o menos)", value: 1 }
                ]
            },
            {
                id: 17,
                dimension: "Dominio Disciplinar",
                question: "¬øQu√© tan c√≥modo me siento explicando conceptos complejos de STEM?",
                options: [
                    { text: "Muy c√≥modo, domino profundamente", value: 4 },
                    { text: "C√≥modo, tengo buen dominio", value: 3 },
                    { text: "Parcialmente c√≥modo", value: 2 },
                    { text: "Necesito mejorar significativamente", value: 1 }
                ]
            },
            {
                id: 18,
                dimension: "Dominio Disciplinar",
                question: "¬øPuedo relacionar los contenidos STEM con aplicaciones del mundo real?",
                options: [
                    { text: "Siempre, es parte integral", value: 4 },
                    { text: "Frecuentemente", value: 3 },
                    { text: "Ocasionalmente", value: 2 },
                    { text: "Raramente", value: 1 }
                ]
            },
            // Competencias Pedag√≥gicas (3)
            {
                id: 19,
                dimension: "Competencias Pedag√≥gicas",
                question: "¬øCon qu√© frecuencia utilizo metodolog√≠as activas (ABP, proyectos, investigaci√≥n)?",
                options: [
                    { text: "En todas mis clases", value: 4 },
                    { text: "En la mayor√≠a de mis clases", value: 3 },
                    { text: "Ocasionalmente", value: 2 },
                    { text: "Raramente", value: 1 }
                ]
            },
            {
                id: 20,
                dimension: "Competencias Pedag√≥gicas",
                question: "¬øC√≥mo adapto mi ense√±anza a diferentes estilos de aprendizaje?",
                options: [
                    { text: "Uso m√∫ltiples estrategias sistem√°ticamente", value: 4 },
                    { text: "Adapto frecuentemente", value: 3 },
                    { text: "Ocasionalmente var√≠o", value: 2 },
                    { text: "Uso principalmente un enfoque tradicional", value: 1 }
                ]
            },
            {
                id: 21,
                dimension: "Competencias Pedag√≥gicas",
                question: "¬øUtilizo la evaluaci√≥n formativa para ajustar mi ense√±anza en tiempo real?",
                options: [
                    { text: "Constantemente", value: 4 },
                    { text: "Frecuentemente", value: 3 },
                    { text: "Ocasionalmente", value: 2 },
                    { text: "Raramente", value: 1 }
                ]
            },
            // Integraci√≥n Interdisciplinaria (3)
            {
                id: 22,
                dimension: "Integraci√≥n Interdisciplinaria",
                question: "¬øCon qu√© facilidad conecto conceptos entre ciencias, tecnolog√≠a, ingenier√≠a y matem√°ticas?",
                options: [
                    { text: "Muy f√°cilmente, es natural", value: 4 },
                    { text: "Frecuentemente hago conexiones", value: 3 },
                    { text: "Ocasionalmente", value: 2 },
                    { text: "Me resulta dif√≠cil", value: 1 }
                ]
            },
            {
                id: 23,
                dimension: "Integraci√≥n Interdisciplinaria",
                question: "¬øDise√±o proyectos que requieren conocimientos de m√∫ltiples √°reas STEM?",
                options: [
                    { text: "Regularmente, es mi enfoque principal", value: 4 },
                    { text: "Frecuentemente", value: 3 },
                    { text: "Ocasionalmente", value: 2 },
                    { text: "Raramente", value: 1 }
                ]
            },
            {
                id: 24,
                dimension: "Integraci√≥n Interdisciplinaria",
                question: "¬øColaboro con docentes de otras disciplinas para crear experiencias integradas?",
                options: [
                    { text: "Regularmente, tengo alianzas", value: 4 },
                    { text: "Frecuentemente colaboro", value: 3 },
                    { text: "Ocasionalmente", value: 2 },
                    { text: "Raramente", value: 1 }
                ]
            },
            // Innovaci√≥n y Resoluci√≥n (3)
            {
                id: 25,
                dimension: "Innovaci√≥n y Resoluci√≥n",
                question: "¬øQu√© tan efectivo soy fomentando la creatividad y el pensamiento divergente?",
                options: [
                    { text: "Muy efectivo, uso m√∫ltiples estrategias", value: 4 },
                    { text: "Efectivo", value: 3 },
                    { text: "Parcialmente efectivo", value: 2 },
                    { text: "Necesito desarrollar m√°s", value: 1 }
                ]
            },
            {
                id: 26,
                dimension: "Innovaci√≥n y Resoluci√≥n",
                question: "¬øPresento problemas abiertos sin una √∫nica soluci√≥n correcta?",
                options: [
                    { text: "Regularmente, es parte central", value: 4 },
                    { text: "Frecuentemente", value: 3 },
                    { text: "Ocasionalmente", value: 2 },
                    { text: "Raramente", value: 1 }
                ]
            },
            {
                id: 27,
                dimension: "Innovaci√≥n y Resoluci√≥n",
                question: "¬øPromuevo que mis estudiantes generen m√∫ltiples soluciones?",
                options: [
                    { text: "Siempre, es fundamental", value: 4 },
                    { text: "Frecuentemente", value: 3 },
                    { text: "A veces", value: 2 },
                    { text: "Raramente", value: 1 }
                ]
            },
            // Pensamiento Computacional (3)
            {
                id: 28,
                dimension: "Pensamiento Computacional",
                question: "¬øQu√© tan c√≥modo me siento ense√±ando programaci√≥n y l√≥gica computacional?",
                options: [
                    { text: "Muy c√≥modo, domino m√∫ltiples lenguajes", value: 4 },
                    { text: "C√≥modo con conceptos b√°sicos-intermedios", value: 3 },
                    { text: "B√°sicamente c√≥modo", value: 2 },
                    { text: "Necesito desarrollar estas habilidades", value: 1 }
                ]
            },
            {
                id: 29,
                dimension: "Pensamiento Computacional",
                question: "¬øEnse√±o a descomponer problemas complejos en partes m√°s simples?",
                options: [
                    { text: "S√≠, es una estrategia fundamental", value: 4 },
                    { text: "Frecuentemente", value: 3 },
                    { text: "A veces", value: 2 },
                    { text: "Es un √°rea que debo desarrollar", value: 1 }
                ]
            },
            {
                id: 30,
                dimension: "Pensamiento Computacional",
                question: "¬øUtilizo herramientas digitales y simulaciones para ense√±ar STEM?",
                options: [
                    { text: "Regularmente, tengo un arsenal amplio", value: 4 },
                    { text: "Frecuentemente", value: 3 },
                    { text: "Ocasionalmente", value: 2 },
                    { text: "Raramente", value: 1 }
                ]
            }
        ];

        // Funciones principales
        function showAdminLogin() {
            document.getElementById('admin-modal').style.display = 'flex';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-error').style.display = 'none';
        }

        function closeAdminModal() {
            document.getElementById('admin-modal').style.display = 'none';
        }

        function validateAdmin() {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                closeAdminModal();
                goToSection('admin');
                loadAdminData();
            } else {
                document.getElementById('admin-error').style.display = 'block';
            }
        }

        function startEvaluation() {
            const form = document.getElementById('teacher-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            teacherInfo = {
                nombres: document.getElementById('nombres').value,
                apellidos: document.getElementById('apellidos').value,
                identificacion: document.getElementById('identificacion').value,
                grado: document.getElementById('grado').value,
                asignatura: document.getElementById('asignatura').value,
                institucion: document.getElementById('institucion').value
            };

            goToSection('knowledge');
            renderKnowledgeQuestions();
        }

        function goToSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + section).classList.add('active');
            
            const steps = ['registration', 'knowledge', 'competencies', 'results'];
            const currentStep = steps.indexOf(section) + 1;
            
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 === currentStep) s.classList.add('active');
                if (i + 1 < currentStep) s.classList.add('completed');
            });

            updateMainProgress(currentStep);
            window.scrollTo(0, 0);
        }

        function updateMainProgress(step) {
            const progress = (step / 4) * 100;
            document.getElementById('mainProgress').style.width = progress + '%';
        }

        function renderKnowledgeQuestions() {
            const container = document.getElementById('knowledge-questions');
            container.innerHTML = knowledgeQuestions.map((q, index) => `
                <div class="question-container">
                    <div class="dimension-label">${q.category}</div>
                    <div class="question">${index + 1}. ${q.question}</div>
                    <div class="options">
                        ${q.options.map((option, optIndex) => `
                            <label class="option" data-question="${q.id}">
                                <input type="radio" name="knowledge_${q.id}" value="${optIndex}" onchange="selectKnowledge(${q.id}, ${optIndex})">
                                <span>${option}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectKnowledge(questionId, answer) {
            knowledgeAnswers[questionId] = answer;
            
            const option = document.querySelector(`[data-question="${questionId}"]`);
            const container = option.closest('.question-container');
            container.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            checkKnowledgeComplete();
        }

        function checkKnowledgeComplete() {
            const allAnswered = Object.keys(knowledgeAnswers).length === knowledgeQuestions.length;
            document.getElementById('btn-to-competencies').disabled = !allAnswered;
        }

        function goToCompetencies() {
            goToSection('competencies');
            renderCompetencyQuestions();
        }

        function renderCompetencyQuestions() {
            const container = document.getElementById('competency-questions');
            container.innerHTML = competencyQuestions.map((q, index) => `
                <div class="question-container">
                    <div class="dimension-label">${q.dimension}</div>
                    <div class="question">${index + 1}. ${q.question}</div>
                    <div class="options">
                        ${q.options.map((option, optIndex) => `
                            <label class="option" data-question="${q.id}">
                                <input type="radio" name="competency_${q.id}" value="${option.value}" onchange="selectCompetency(${q.id}, ${option.value})">
                                <span>${option.text}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectCompetency(questionId, value) {
            competencyAnswers[questionId] = value;
            
            const option = document.querySelector(`label[data-question="${questionId}"]`);
            const container = option.closest('.question-container');
            container.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            checkCompetencyComplete();
        }

        function checkCompetencyComplete() {
            const allAnswered = Object.keys(competencyAnswers).length === competencyQuestions.length;
            document.getElementById('btn-to-results').disabled = !allAnswered;
        }

        function generateResults() {
            const knowledgeScore = calculateKnowledgeScore();
            const competencyScore = calculateCompetencyScore();
            const overallScore = (knowledgeScore.percentage + competencyScore.overall) / 2;

            const result = {
                ...teacherInfo,
                knowledgeScore: knowledgeScore,
                competencyScore: competencyScore,
                overallScore: overallScore,
                fecha: new Date().toISOString(),
                fechaLegible: new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };

            allResults.push(result);
            localStorage.setItem('stemEvaluationResults', JSON.stringify(allResults));

            displayResults(result);
            goToSection('results');
        }

        function calculateKnowledgeScore() {
            let correct = 0;
            const categories = {};

            knowledgeQuestions.forEach(q => {
                if (!categories[q.category]) categories[q.category] = { correct: 0, total: 0 };
                categories[q.category].total++;
                
                if (knowledgeAnswers[q.id] === q.correct) {
                    correct++;
                    categories[q.category].correct++;
                }
            });

            return {
                correct: correct,
                total: knowledgeQuestions.length,
                percentage: Math.round((correct / knowledgeQuestions.length) * 100),
                categories: categories
            };
        }

        function calculateCompetencyScore() {
            const dimensions = {};

            competencyQuestions.forEach(q => {
                if (!dimensions[q.dimension]) dimensions[q.dimension] = [];
                dimensions[q.dimension].push(competencyAnswers[q.id]);
            });

            const dimensionScores = {};
            for (let dim in dimensions) {
                const avg = dimensions[dim].reduce((a, b) => a + b, 0) / dimensions[dim].length;
                dimensionScores[dim] = {
                    score: avg,
                    percentage: Math.round((avg / 4) * 100)
                };
            }

            const overallScore = Object.values(dimensionScores).reduce((sum, dim) => sum + dim.percentage, 0) / Object.keys(dimensionScores).length;

            return {
                dimensions: dimensionScores,
                overall: Math.round(overallScore)
            };
        }

        function displayResults(result) {
            const container = document.getElementById('results-content');
            
            let html = `
                <h2 style="text-align: center; color: #333; margin-bottom: 30px;">üéâ ¬°Evaluaci√≥n Completada!</h2>
                
                <div class="result-section" style="text-align: center;">
                    <div class="score-circle">${Math.round(result.overallScore)}%</div>
                    <h3>${getOverallLevel(result.overallScore)}</h3>
                    <p style="font-size: 1.1em; color: #666;">Puntuaci√≥n General Integral</p>
                </div>

                <div class="result-section">
                    <h3>üìù Parte 1: Conocimientos STEM</h3>
                    <p><strong>${result.knowledgeScore.correct}/${result.knowledgeScore.total}</strong> respuestas correctas</p>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${result.knowledgeScore.percentage}%"></div>
                    </div>
                    <p><strong>${result.knowledgeScore.percentage}%</strong> de dominio</p>
                    
                    <h4 style="margin-top: 20px;">Por Categor√≠a:</h4>
                    ${Object.entries(result.knowledgeScore.categories).map(([cat, data]) => {
                        const pct = Math.round((data.correct / data.total) * 100);
                        return `
                            <div style="margin: 10px 0;">
                                <strong>${cat}:</strong> ${data.correct}/${data.total} (${pct}%)
                                <div class="score-bar" style="height: 10px;">
                                    <div class="score-fill" style="width: ${pct}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="result-section">
                    <h3>üéØ Parte 2: Competencias Pedag√≥gicas</h3>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${result.competencyScore.overall}%"></div>
                    </div>
                    <p><strong>${result.competencyScore.overall}%</strong> de desarrollo competencial</p>
                    
                    <h4 style="margin-top: 20px;">Por Dimensi√≥n:</h4>
                    ${Object.entries(result.competencyScore.dimensions).map(([dim, data]) => `
                        <div style="margin: 15px 0;">
                            <strong>${dim}:</strong> ${data.score.toFixed(1)}/4.0 ${getDimensionLevel(data.score)}
                            <div class="score-bar" style="height: 10px;">
                                <div class="score-fill" style="width: ${data.percentage}%"></div>
                            </div>
                            <p>${data.percentage}%</p>
                        </div>
                    `).join('')}
                </div>

                <div class="recommendations">
                    <h3>üí° Recomendaciones Personalizadas</h3>
                    ${generateRecommendations(result).map(rec => `<p>‚Ä¢ ${rec}</p>`).join('')}
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="goToSection('registration')">Finalizar</button>
                </div>
            `;

            container.innerHTML = html;
        }

        function getOverallLevel(score) {
            if (score >= 90) return "üèÜ Nivel Excelente";
            if (score >= 75) return "‚úÖ Nivel Avanzado";
            if (score >= 60) return "üìà Nivel Intermedio";
            if (score >= 40) return "‚ö†Ô∏è Nivel B√°sico";
            return "üîÑ Nivel Inicial";
        }

        function getDimensionLevel(score) {
            if (score >= 3.5) return "üèÜ Excelente";
            if (score >= 2.5) return "‚úÖ Bueno";
            if (score >= 1.5) return "‚ö†Ô∏è En desarrollo";
            return "üîÑ Necesita atenci√≥n";
        }

        function generateRecommendations(result) {
            const recs = [];
            
            if (result.knowledgeScore.percentage < 70) {
                recs.push("üìö Fortalece tus conocimientos STEM: Considera cursos de actualizaci√≥n en las √°reas con menor puntuaci√≥n.");
            }

            for (let dim in result.competencyScore.dimensions) {
                if (result.competencyScore.dimensions[dim].score < 2.5) {
                    recs.push(`üéØ ${dim}: Desarrolla esta competencia con formaci√≥n espec√≠fica y pr√°ctica sistem√°tica.`);
                }
            }

            if (recs.length === 0) {
                recs.push("üåü ¬°Excelente trabajo! Mant√©n tu nivel de actualizaci√≥n y considera compartir tu experiencia con otros docentes.");
            }

            recs.push("üìä Realiza esta evaluaci√≥n nuevamente en 6 meses para medir tu progreso.");
            
            return recs;
        }

        function loadAdminData() {
            populateFilters();
            updateAdminStats();
            renderAdminCharts();
        }

        function populateFilters() {
            const grados = [...new Set(allResults.map(r => r.grado))].sort();
            const asignaturas = [...new Set(allResults.map(r => r.asignatura))].sort();

            document.getElementById('filter-grado').innerHTML = '<option value="">Todos los Grados</option>' + 
                grados.map(g => `<option value="${g}">${g}</option>`).join('');
            
            document.getElementById('filter-asignatura').innerHTML = '<option value="">Todas las Asignaturas</option>' + 
                asignaturas.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function getFilteredResults() {
            const gradoFilter = document.getElementById('filter-grado')?.value || '';
            const asignaturaFilter = document.getElementById('filter-asignatura')?.value || '';

            return allResults.filter(r => {
                return (!gradoFilter || r.grado === gradoFilter) &&
                       (!asignaturaFilter || r.asignatura === asignaturaFilter);
            });
        }

        function filterStats() {
            updateAdminStats();
            renderAdminCharts();
        }

        function updateAdminStats() {
            const filtered = getFilteredResults();

            if (filtered.length === 0) {
                document.getElementById('total-teachers').textContent = '0';
                document.getElementById('avg-knowledge').textContent = '0%';
                document.getElementById('avg-competencies').textContent = '0%';
                document.getElementById('avg-general').textContent = '0%';
                document.getElementById('results-tbody').innerHTML = '<tr><td colspan="8" style="text-align:center;">No hay datos disponibles</td></tr>';
                return;
            }

            const avgKnowledge = Math.round(filtered.reduce((sum, r) => sum + r.knowledgeScore.percentage, 0) / filtered.length);
            const avgCompetencies = Math.round(filtered.reduce((sum, r) => sum + r.competencyScore.overall, 0) / filtered.length);
            const avgGeneral = Math.round(filtered.reduce((sum, r) => sum + r.overallScore, 0) / filtered.length);

            document.getElementById('total-teachers').textContent = filtered.length;
            document.getElementById('avg-knowledge').textContent = avgKnowledge + '%';
            document.getElementById('avg-competencies').textContent = avgCompetencies + '%';
            document.getElementById('avg-general').textContent = avgGeneral + '%';

            updateResultsTable(filtered);
        }

        function updateResultsTable(filtered) {
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = filtered.map(r => `
                <tr>
                    <td>${r.nombres} ${r.apellidos}</td>
                    <td>${r.identificacion}</td>
                    <td>${r.grado}</td>
                    <td>${r.asignatura}</td>
                    <td><strong>${r.knowledgeScore.percentage}%</strong></td>
                    <td><strong>${r.competencyScore.overall}%</strong></td>
                    <td><strong>${Math.round(r.overallScore)}%</strong></td>
                    <td>${r.fechaLegible}</td>
                </tr>
            `).join('');
        }

        function renderAdminCharts() {
            const filtered = getFilteredResults();
            if (filtered.length === 0) return;

            renderKnowledgeChart(filtered);
            renderCompetencyChart(filtered);
            renderGradeChart(filtered);
            renderSubjectChart(filtered);
        }

        function renderKnowledgeChart(data) {
            const ctx = document.getElementById('knowledgeChart');
            if (!ctx) return;

            const categories = ['Ciencia', 'Matem√°ticas', 'Tecnolog√≠a', 'Ingenier√≠a', 'Integraci√≥n STEM'];
            const avgScores = categories.map(cat => {
                const scores = data.map(r => {
                    const catData = r.knowledgeScore.categories[cat];
                    return catData ? (catData.correct / catData.total) * 100 : 0;
                });
                return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            });

            if (currentChart1) currentChart1.destroy();
            currentChart1 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Promedio Conocimientos (%)',
                        data: avgScores,
                        backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#E91E63']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Conocimientos por Categor√≠a'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function renderCompetencyChart(data) {
            const ctx = document.getElementById('competencyChart');
            if (!ctx) return;

            const dimensions = ['Dominio Disciplinar', 'Competencias Pedag√≥gicas', 'Integraci√≥n Interdisciplinaria', 'Innovaci√≥n y Resoluci√≥n', 'Pensamiento Computacional'];
            const avgScores = dimensions.map(dim => {
                const scores = data.map(r => r.competencyScore.dimensions[dim]?.percentage || 0);
                return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            });

            if (currentChart2) currentChart2.destroy();
            currentChart2 = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensions,
                    datasets: [{
                        label: 'Promedio Competencias (%)',
                        data: avgScores,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgb(102, 126, 234)',
                        pointBackgroundColor: 'rgb(102, 126, 234)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Competencias por Dimensi√≥n'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function renderGradeChart(data) {
            const ctx = document.getElementById('gradeChart');
            if (!ctx) return;

            const gradeScores = {};
            data.forEach(r => {
                if (!gradeScores[r.grado]) gradeScores[r.grado] = [];
                gradeScores[r.grado].push(r.overallScore);
            });

            const labels = Object.keys(gradeScores).sort();
            const avgScores = labels.map(grade => {
                const scores = gradeScores[grade];
                return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            });

            if (currentChart3) currentChart3.destroy();
            currentChart3 = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Promedio por Grado (%)',
                        data: avgScores,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Rendimiento por Grado'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function renderSubjectChart(data) {
            const ctx = document.getElementById('subjectChart');
            if (!ctx) return;

            const subjectScores = {};
            data.forEach(r => {
                if (!subjectScores[r.asignatura]) subjectScores[r.asignatura] = [];
                subjectScores[r.asignatura].push(r.overallScore);
            });

            const labels = Object.keys(subjectScores);
            const avgScores = labels.map(subject => {
                const scores = subjectScores[subject];
                return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            });

            if (currentChart4) currentChart4.destroy();
            currentChart4 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Promedio por Asignatura (%)',
                        data: avgScores,
                        backgroundColor: '#FF9800'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        title: {
                            display: true,
                            text: 'Rendimiento por Asignatura'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function downloadAllResults() {
            const filtered = getFilteredResults();
            const csvContent = generateCSV(filtered);
            downloadCSV(csvContent, `Evaluacion_STEM_Integral_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function generateCSV(data) {
            const headers = [
                'Nombres', 'Apellidos', 'Identificaci√≥n', 'Grado', 'Asignatura', 'Instituci√≥n',
                'Conocimientos (%)', 'Competencias (%)', 'Puntuaci√≥n General (%)',
                'Ciencia', 'Matem√°ticas', 'Tecnolog√≠a', 'Ingenier√≠a', 'Integraci√≥n STEM',
                'Dominio Disciplinar', 'Competencias Pedag√≥gicas', 'Integraci√≥n Interdisciplinaria', 
                'Innovaci√≥n y Resoluci√≥n', 'Pensamiento Computacional', 'Fecha'
            ];

            const rows = data.map(r => [
                r.nombres,
                r.apellidos,
                r.identificacion,
                r.grado,
                r.asignatura,
                r.institucion,
                r.knowledgeScore.percentage,
                r.competencyScore.overall,
                Math.round(r.overallScore),
                Math.round((r.knowledgeScore.categories['Ciencia']?.correct || 0) / (r.knowledgeScore.categories['Ciencia']?.total || 1) * 100),
                Math.round((r.knowledgeScore.categories['Matem√°ticas']?.correct || 0) / (r.knowledgeScore.categories['Matem√°ticas']?.total || 1) * 100),
                Math.round((r.knowledgeScore.categories['Tecnolog√≠a']?.correct || 0) / (r.knowledgeScore.categories['Tecnolog√≠a']?.total || 1) * 100),
                Math.round((r.knowledgeScore.categories['Ingenier√≠a']?.correct || 0) / (r.knowledgeScore.categories['Ingenier√≠a']?.total || 1) * 100),
                Math.round((r.knowledgeScore.categories['Integraci√≥n STEM']?.correct || 0) / (r.knowledgeScore.categories['Integraci√≥n STEM']?.total || 1) * 100),
                r.competencyScore.dimensions['Dominio Disciplinar']?.percentage || 0,
                r.competencyScore.dimensions['Competencias Pedag√≥gicas']?.percentage || 0,
                r.competencyScore.dimensions['Integraci√≥n Interdisciplinaria']?.percentage || 0,
                r.competencyScore.dimensions['Innovaci√≥n y Resoluci√≥n']?.percentage || 0,
                r.competencyScore.dimensions['Pensamiento Computacional']?.percentage || 0,
                r.fechaLegible
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(content, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function generatePDFReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const filtered = getFilteredResults();

            doc.setFontSize(18);
            doc.text('Reporte Evaluacion STEM Integral', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
            doc.text(`Total Evaluados: ${filtered.length}`, 20, 40);

            if (filtered.length > 0) {
                const avgKnowledge = Math.round(filtered.reduce((sum, r) => sum + r.knowledgeScore.percentage, 0) / filtered.length);
                const avgCompetencies = Math.round(filtered.reduce((sum, r) => sum + r.competencyScore.overall, 0) / filtered.length);
                const avgGeneral = Math.round(filtered.reduce((sum, r) => sum + r.overallScore, 0) / filtered.length);
                
                doc.text(`Promedio Conocimientos: ${avgKnowledge}%`, 20, 50);
                doc.text(`Promedio Competencias: ${avgCompetencies}%`, 20, 60);
                doc.text(`Promedio General: ${avgGeneral}%`, 20, 70);

                let y = 90;
                doc.setFontSize(14);
                doc.text('Resultados por Docente:', 20, y);
                y += 10;

                doc.setFontSize(10);
                filtered.slice(0, 15).forEach((r, i) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(`${i + 1}. ${r.nombres} ${r.apellidos}`, 20, y);
                    doc.text(`Conocimientos: ${r.knowledgeScore.percentage}% | Competencias: ${r.competencyScore.overall}% | General: ${Math.round(r.overallScore)}%`, 25, y + 5);
                    y += 12;
                });
            }

            doc.save(`Reporte_STEM_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        async function sendToGoogleSheets() {
            if (!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL === "TU_URL_DE_GOOGLE_SHEETS_AQUI") {
                alert('‚ö†Ô∏è Primero debes configurar la URL de Google Sheets.\n\nPasos:\n1. Crea un Google Sheet\n2. Usa Google Apps Script\n3. Configura la URL en el c√≥digo\n\nConsulta las instrucciones completas.');
                return;
            }

            const filtered = getFilteredResults();
            
            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filtered)
                });

                alert('‚úÖ Datos enviados exitosamente a Google Sheets');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al enviar datos. Verifica la configuraci√≥n.');
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema de Evaluaci√≥n STEM Integral Cargado');
        });
    </script>
</body>
</html>
                